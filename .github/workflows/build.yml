name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bison \
          flex \
          build-essential \
          cmake \
          autoconf \
          autoconf-archive \
          automake \
          libtool \
          libx11-dev \
          libxft-dev \
          libxext-dev \
          libxtst-dev \
          libxrandr-dev \
          ninja-build \
          pkg-config

    - name: Bootstrap vcpkg
      working-directory: ${{ github.workspace }}
      run: |
        chmod +x ./vcpkg/bootstrap-vcpkg.sh
        ./vcpkg/bootstrap-vcpkg.sh

    - name: Set vcpkg environment variables
      run: |
        echo "VCPKG_ROOT=${{ github.workspace }}/vcpkg" >> $GITHUB_ENV
        echo "${{ github.workspace }}/vcpkg" >> $GITHUB_PATH

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.13'
        environment-name: robotic_notes
        activate-environment: robotic_notes

    - name: Install Python dependencies
      shell: bash -l {0}
      run: |
        conda activate robotic_notes
        pip install rerun-sdk
        conda install -c conda-forge opencv -y
        pip install graphslam
        conda install -c conda-forge gtsam -y
        conda install -c conda-forge matplotlib -y
        conda install -c conda-forge plotly -y
        conda install -c conda-forge jupyterlab -y
        pip install gradio_rerun

    - name: Configure CMake
      working-directory: ${{ github.workspace }}
      run: |
        cmake -S . -B build \
          -DCMAKE_TOOLCHAIN_FILE=./vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build C++ project
      working-directory: ${{ github.workspace }}
      run: |
        cmake --build build --parallel $(nproc)

    - name: Verify build
      working-directory: ${{ github.workspace }}
      run: |
        echo "=== C++ Build Verification ==="
        ls -la build/
        echo ""
        echo "=== Python Environment Verification ==="
        conda activate robotic_notes
        python --version
        python -c "import rerun; print('rerun-sdk:', rerun.__version__)"
        python -c "import cv2; print('opencv:', cv2.__version__)"

